name: Trivy Scan Kubernetes Manifests

on:
  pull_request:
    branches: [main, develop, release/*, hotfix/*]
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'

env:
  TRIVY_SEVERITY: 'HIGH,CRITICAL'
  TRIVY_CACHE_DIR: ${{ github.workspace }}/.cache/trivy

jobs:
  scan-and-report:
    name: Scan and Generate Report
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    outputs:
      # Define una salida para compartir el estado del escaneo con otros jobs
      has-critical-issues: ${{ steps.analyze-severity.outputs.has-critical-issues }}

    steps:
      # Paso 1: Obtener el código fuente del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # Paso 2: Restaurar caché de la base de datos de vulnerabilidades de Trivy
      # Esto acelera el escaneo al reutilizar datos descargados previamente
      - name: Restore Trivy Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          # La clave del cache incluye la fecha para invalidación semanal
          key: cache-trivy-${{ steps.get-date.outputs.date }}
          restore-keys: |
            cache-trivy-

      # Paso 3: Obtener la fecha actual para el sistema de caché
      # Se usa para crear claves de caché con invalidación temporal
      - name: Get current date
        id: get-date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # Paso 4: Instalar y ejecutar Trivy para escanear configuraciones de Kubernetes
      # Este paso siempre instala Trivy (skip-setup-trivy: false)
      - name: Run Trivy Configuration Scan
        uses: aquasecurity/trivy-action@0.33.1
        id: trivy-scan  # Identificador para referenciar este paso
        with:
          scan-type: 'config'           # Escanea archivos YAML/JSON de Kubernetes
          scan-ref: '.'                 # Escanea el directorio actual
          format: 'sarif'               # Formato compatible con GitHub Security
          output: 'trivy-results.sarif' # Archivo de resultados
          severity: ${{ env.TRIVY_SEVERITY }} # Filtra por severidad configurada
          ignore-unfixed: true          # Ignora vulnerabilidades sin parche disponible
          exit-code: 0                  # No falla el workflow, solo reporta
          skip-setup-trivy: false       # IMPORTANTE: Siempre instala Trivy

      # Paso 5: Subir resultados al GitHub Security Tab para visibilidad centralizada
      # Los resultados aparecen en la pestaña Security del repositorio
      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()  # Ejecuta siempre, incluso si Trivy falla
        with:
          sarif_file: 'trivy-results.sarif'
          # SARIF es un estándar de la industria para reportar vulnerabilidades

      # Paso 6: Guardar cache para futuros escaneos
      # Optimiza ejecuciones posteriores del workflow
      - name: Save Trivy Cache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: cache-trivy-${{ steps.get-date.outputs.date }}

      # Paso 7: Analizar si hay vulnerabilidades críticas para decisión de bloqueo
      # Crea un output que otros jobs pueden consumir
      - name: Analyze Scan Results
        id: analyze-severity
        # Verifica si Trivy encontró vulnerabilidades del nivel configurado
        run: |
          if [ -f "trivy-results.sarif" ] && [ -s "trivy-results.sarif" ]; then
            echo "Tiene vulnerabilidades del nivel ${{ env.TRIVY_SEVERITY }} o superior"
            echo "has-critical-issues=true" >> $GITHUB_OUTPUT
          else
            echo "No se encontraron vulnerabilidades"
            echo "has-critical-issues=false" >> $GITHUB_OUTPUT
          fi

  enforce-security-gate:
    name: Enforce Security Gate
    runs-on: ubuntu-latest
    needs: scan-and-report  # Depende del job de escaneo
    # Solo ejecuta en PRs que tengan vulnerabilidades críticas
    if: github.event_name == 'pull_request' && needs.scan-and-report.outputs.has-critical-issues == 'true'

    steps:
      # Paso 1: Obtener el código para escanear
      - name: Checkout repository
        uses: actions/checkout@v4

      # Paso 2: Ejecutar Trivy en modo estricto que falla con vulnerabilidades críticas
      # Este es el "gate" de seguridad que bloquea PRs peligrosos
      - name: Run Trivy with Strict Enforcement
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'          # Formato legible en la consola de GitHub
          severity: 'CRITICAL'     # Solo bloquea con vulnerabilidades CRITICAL
          ignore-unfixed: true
          exit-code: 1             # Falla el workflow si encuentra issues
          skip-setup-trivy: false  # IMPORTANTE: Debe instalar Trivy aquí también
          # Cada job de GitHub Actions tiene un entorno limpio