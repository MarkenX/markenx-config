# Pipeline de GitHub Actions para generar reportes de seguridad de manifiestos de Kubernetes usando Trivy
# Este workflow se ejecuta en tres escenarios:
# - Push a la rama main
# - Pull requests hacia main, develop, y ramas de release/hotfix
# - Programación semanal cada domingo a medianoche
name: Trivy Kubernetes Manifests Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop, release/*, hotfix/*]
  schedule:
    - cron: '0 0 * * 0'

# Permisos necesarios para que el workflow pueda escribir en el repositorio
# y publicar en GitHub Pages
permissions:
  contents: write

jobs:
  trivy-report:
    runs-on: ubuntu-latest

    steps:
      # Descarga el código fuente del repositorio en el runner de GitHub Actions
      # Utiliza la versión 4 de la acción oficial de checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # Descarga la plantilla HTML oficial de Trivy desde el repositorio de GitHub
      # Crea un directorio para almacenar la plantilla y utiliza curl para obtenerla
      # Esta plantilla es necesaria para generar el reporte con el formato HTML adecuado
      - name: Download Trivy HTML template
        run: |
          mkdir -p trivy-templates
          curl -sSL \
            https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl \
            -o trivy-templates/html.tpl

      # Crea el directorio que contendrá el sitio web a publicar
      # Este directorio será usado para almacenar el reporte HTML generado
      - name: Prepare site directory
        run: mkdir -p site

      # Ejecuta un escaneo de seguridad sobre archivos de configuración usando Trivy
      # Genera un reporte en formato HTML como index.html dentro del directorio site
      # Configurado para no fallar el pipeline y para ignorar vulnerabilidades sin fix disponible
      - name: Run Trivy config scan (HTML report)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: .
          format: template
          template: "@trivy-templates/k8s-html.tpl"
          output: site/index.html
          exit-code: 0
          ignore-unfixed: true

      # Publica el reporte HTML generado en GitHub Pages
      # El reporte quedará accesible públicamente a través de la URL de GitHub Pages del repositorio
      # Solo se publica el contenido del directorio site en la rama gh-pages
      - name: Publish report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: site